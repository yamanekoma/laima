<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Laima - Baltic Task Manager</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1d21">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a1d21;
      --bg-secondary: #252a30;
      --bg-card: #2d333b;
      --bg-elevated: #353d47;
      --text-primary: #f0ebe3;
      --text-secondary: #b8b2a7;
      --text-muted: #7d7a75;
      --accent-amber: #d4a853;
      --accent-amber-light: #e8c274;
      --accent-amber-dark: #b8923f;
      --accent-forest: #5a8a6e;
      --accent-forest-light: #6fa583;
      --accent-brick: #c17f59;
      --accent-brick-light: #d4956f;
      --accent-sea: #6a8fa3;
      --accent-linen: #3d4450;
      --accent-cream: #2a2f36;
      --border-light: #3d444d;
      --border-pattern: rgba(212, 168, 83, 0.15);
      --success: #6fa583;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Source Sans 3', -apple-system, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      position: relative;
    }

    /* Baltic traditional geometric pattern background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        /* Auseklis (Morning Star) - Latvian symbol */
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 80px,
          var(--border-pattern) 80px,
          var(--border-pattern) 81px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 80px,
          var(--border-pattern) 80px,
          var(--border-pattern) 81px
        ),
        /* Diagonal cross pattern */
        repeating-linear-gradient(
          45deg,
          transparent,
          transparent 56px,
          rgba(90, 138, 110, 0.08) 56px,
          rgba(90, 138, 110, 0.08) 57px
        ),
        repeating-linear-gradient(
          -45deg,
          transparent,
          transparent 56px,
          rgba(90, 138, 110, 0.08) 56px,
          rgba(90, 138, 110, 0.08) 57px
        );
      pointer-events: none;
      z-index: 0;
    }

    /* Additional decorative corner patterns */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        /* Top left Žvaigždė (star) inspired glow */
        radial-gradient(ellipse at 10% 10%, rgba(212, 168, 83, 0.1) 0%, transparent 40%),
        /* Bottom right subtle glow */
        radial-gradient(ellipse at 90% 90%, rgba(90, 138, 110, 0.08) 0%, transparent 40%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      padding: 24px 20px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 36px 0 28px;
    }

    .header-logo {
      display: inline-flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 6px;
    }

    .header-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Baltic Sun Symbol (Saule) */
    .header-icon svg {
      width: 40px;
      height: 40px;
    }

    .header h1 {
      font-family: 'Libre Baskerville', serif;
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--accent-amber-light);
      letter-spacing: 0.02em;
      text-shadow: 0 2px 12px rgba(212, 168, 83, 0.3);
    }

    .header .subtitle {
      font-size: 0.7rem;
      color: var(--text-secondary);
      letter-spacing: 0.3em;
      text-transform: uppercase;
      margin-top: 6px;
      font-weight: 500;
    }

    .current-time {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-top: 16px;
      font-weight: 500;
    }

    .night-mode-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: var(--bg-card);
      padding: 6px 16px;
      border-radius: 20px;
      margin-top: 12px;
      border: 1px solid var(--border-light);
    }

    /* Welcome Back Card */
    .welcome-card {
      background: linear-gradient(135deg, var(--accent-amber-dark) 0%, rgba(184, 146, 63, 0.8) 100%);
      border-radius: var(--radius-lg);
      padding: 20px 24px;
      margin-bottom: 16px;
      color: var(--bg-primary);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(212, 168, 83, 0.3);
    }

    .welcome-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -30%;
      width: 60%;
      height: 200%;
      background: rgba(255,255,255,0.1);
      transform: rotate(15deg);
      pointer-events: none;
    }

    /* Baltic pattern overlay on welcome card */
    .welcome-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: 
        repeating-linear-gradient(
          90deg,
          transparent 0px,
          transparent 20px,
          rgba(26, 29, 33, 0.1) 20px,
          rgba(26, 29, 33, 0.1) 21px
        );
      pointer-events: none;
    }

    .welcome-card h3 {
      font-family: 'Libre Baskerville', serif;
      font-size: 1.15rem;
      font-weight: 700;
      margin-bottom: 12px;
      position: relative;
      color: #1a1d21;
    }

    .welcome-stats {
      display: flex;
      gap: 20px;
      position: relative;
    }

    .welcome-stat {
      text-align: center;
    }

    .welcome-stat-value {
      font-size: 1.8rem;
      font-weight: 600;
      line-height: 1;
      color: #1a1d21;
    }

    .welcome-stat-label {
      font-size: 0.7rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 4px;
      color: #2d333b;
    }

    .welcome-message {
      margin-top: 14px;
      font-size: 0.85rem;
      line-height: 1.5;
      border-top: 1px solid rgba(26, 29, 33, 0.2);
      padding-top: 14px;
      position: relative;
      color: #252a30;
    }

    .welcome-card.hidden {
      display: none;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      border: 1px solid var(--border-light);
    }

    /* Voice Input Section */
    .voice-section {
      text-align: center;
    }

    .voice-btn {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px solid var(--accent-amber);
      background: var(--bg-elevated);
      color: var(--accent-amber);
      font-size: 1.5rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      position: relative;
    }

    .voice-btn:hover {
      background: var(--accent-amber);
      color: var(--bg-primary);
      box-shadow: 0 0 20px rgba(212, 168, 83, 0.4);
    }

    .voice-btn.listening {
      background: var(--accent-amber);
      color: var(--bg-primary);
      animation: gentlePulse 2s infinite;
      box-shadow: 0 0 30px rgba(212, 168, 83, 0.5);
    }

    .voice-btn.listening::before {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 1px solid var(--accent-amber);
      opacity: 0.5;
      animation: expandRing 2s infinite;
    }

    @keyframes gentlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    @keyframes expandRing {
      0% { transform: scale(1); opacity: 0.5; }
      100% { transform: scale(1.4); opacity: 0; }
    }

    .voice-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      min-height: 24px;
      margin-bottom: 20px;
    }

    /* Input Group */
    .input-group {
      display: flex;
      gap: 10px;
    }

    .input-group input {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
    }

    .input-group input:focus {
      border-color: var(--accent-amber);
      background: var(--bg-elevated);
    }

    .input-group input::placeholder {
      color: var(--text-muted);
    }

    .btn {
      padding: 14px 24px;
      background: var(--accent-amber);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--accent-amber-light);
      box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-secondary:hover {
      background: var(--accent-linen);
    }

    /* AI Assistant */
    .ai-section {
      position: relative;
    }

    .ai-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .ai-avatar {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--accent-forest) 0%, var(--accent-forest-light) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      box-shadow: 0 2px 8px rgba(90, 138, 110, 0.3);
    }

    .ai-info {
      flex: 1;
    }

    .ai-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .ai-status {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .ai-message {
      background: var(--bg-elevated);
      padding: 16px 20px;
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      line-height: 1.7;
      color: var(--text-primary);
      position: relative;
      border-left: 3px solid var(--accent-forest);
    }

    .ai-message.loading {
      color: var(--text-secondary);
    }

    .ai-message.loading::after {
      content: '';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: ' ·'; }
      40% { content: ' · ·'; }
      60%, 100% { content: ' · · ·'; }
    }

    .ai-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }

    .ai-action-btn {
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.8rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-action-btn:hover {
      border-color: var(--accent-amber);
      color: var(--accent-amber);
      background: var(--bg-elevated);
    }

    /* Task Section */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-family: 'Libre Baskerville', serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .task-count {
      background: var(--accent-forest);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* Progress Bar */
    .progress-section {
      margin-bottom: 20px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .progress-value {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent-forest-light);
    }

    .progress-bar {
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-forest) 0%, var(--accent-forest-light) 100%);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* Task List */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .task-item {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 18px 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
      transition: all 0.25s ease;
      position: relative;
    }

    .task-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
      border-color: var(--accent-amber-dark);
    }

    .task-item.completed {
      opacity: 0.5;
      background: var(--bg-secondary);
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .task-item.urgent {
      border-left: 3px solid var(--accent-brick);
    }

    .task-item.in-progress {
      border-left: 3px solid var(--accent-amber);
      background: var(--bg-elevated);
    }

    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }

    .task-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border-light);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      margin-top: 2px;
    }

    .task-checkbox:hover {
      border-color: var(--accent-amber);
    }

    .task-checkbox.checked {
      background: var(--accent-forest);
      border-color: var(--accent-forest);
      color: white;
      font-size: 0.7rem;
    }

    .task-content {
      flex: 1;
      min-width: 0;
    }

    .task-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.75rem;
    }

    .task-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
    }

    .task-time {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }

    .task-category {
      color: white;
    }

    .task-category.deadline {
      background: var(--accent-brick);
    }

    .task-category.research {
      background: var(--accent-sea);
    }

    .task-category.create {
      background: var(--accent-forest);
    }

    .task-duration {
      background: transparent;
      color: var(--text-muted);
      padding-left: 0;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border-light);
    }

    .task-action-btn {
      padding: 8px 14px;
      background: transparent;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.75rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .task-action-btn:hover {
      background: var(--bg-elevated);
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .task-action-btn.delete:hover {
      border-color: #e57373;
      color: #e57373;
      background: rgba(229, 115, 115, 0.1);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      stroke: var(--border-light);
      stroke-width: 1;
      fill: none;
      margin-bottom: 16px;
    }

    .empty-state p {
      font-size: 0.9rem;
      line-height: 1.7;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      padding: 16px 24px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 14px;
      z-index: 1000;
      opacity: 0;
      transition: all 0.4s ease;
      border: 1px solid var(--accent-amber);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast-icon {
      width: 36px;
      height: 36px;
      background: var(--accent-amber);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: var(--bg-primary);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .toast-message {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 32px;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      animation: modalSlide 0.3s ease;
      border: 1px solid var(--border-light);
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal h3 {
      font-family: 'Libre Baskerville', serif;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-amber-light);
      margin-bottom: 24px;
    }

    .modal-field {
      margin-bottom: 18px;
    }

    .modal-field label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .modal-field input,
    .modal-field select {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
    }

    .modal-field input:focus,
    .modal-field select:focus {
      border-color: var(--accent-amber);
      background: var(--bg-elevated);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 28px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .modal-btn.primary {
      background: var(--accent-amber);
      color: var(--bg-primary);
    }

    .modal-btn.primary:hover {
      background: var(--accent-amber-light);
    }

    .modal-btn.secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .modal-btn.secondary:hover {
      background: var(--accent-linen);
    }

    /* Bottom spacer */
    .bottom-spacer {
      height: 80px;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-logo">
        <div class="header-icon">
          <!-- Baltic Sun Symbol (Saule) with Auseklis elements -->
          <svg viewBox="0 0 40 40" fill="none">
            <!-- Outer rays -->
            <line x1="20" y1="2" x2="20" y2="9" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <line x1="20" y1="31" x2="20" y2="38" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <line x1="2" y1="20" x2="9" y2="20" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <line x1="31" y1="20" x2="38" y2="20" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <!-- Diagonal rays -->
            <line x1="7.3" y1="7.3" x2="12.2" y2="12.2" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <line x1="27.8" y1="27.8" x2="32.7" y2="32.7" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <line x1="7.3" y1="32.7" x2="12.2" y2="27.8" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <line x1="27.8" y1="12.2" x2="32.7" y2="7.3" stroke="#d4a853" stroke-width="2" stroke-linecap="round"/>
            <!-- Center sun -->
            <circle cx="20" cy="20" r="8" stroke="#e8c274" stroke-width="2" fill="none"/>
            <circle cx="20" cy="20" r="3" fill="#d4a853"/>
          </svg>
        </div>
        <h1>Laima</h1>
      </div>
      <p class="subtitle">Baltic Task Manager</p>
      <p class="current-time" id="currentTime"></p>
      <div class="night-mode-indicator" id="nightIndicator" style="display: none;">
        ☽ 夜間モード（通知音オフ）
      </div>
    </header>

    <!-- Welcome Back Card -->
    <section class="welcome-card hidden" id="welcomeCard">
      <h3 id="welcomeTitle">Labas rytas!</h3>
      <div class="welcome-stats">
        <div class="welcome-stat">
          <div class="welcome-stat-value" id="statRemaining">0</div>
          <div class="welcome-stat-label">残りタスク</div>
        </div>
        <div class="welcome-stat">
          <div class="welcome-stat-value" id="statCompleted">0</div>
          <div class="welcome-stat-label">完了済み</div>
        </div>
        <div class="welcome-stat">
          <div class="welcome-stat-value" id="statProgress">0%</div>
          <div class="welcome-stat-label">進捗率</div>
        </div>
      </div>
      <div class="welcome-message" id="welcomeMessage">
        前回の続きから再開しましょう。
      </div>
    </section>

    <!-- Voice Input Section -->
    <section class="card voice-section">
      <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceInput()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
      </button>
      <p class="voice-text" id="voiceText">タップして音声入力</p>
      
      <div class="input-group">
        <input type="text" id="manualInput" placeholder="タスクを追加...">
        <button class="btn" onclick="processManualInput()">追加</button>
      </div>
    </section>

    <!-- AI Assistant -->
    <section class="card ai-section">
      <div class="ai-header">
        <div class="ai-avatar">✦</div>
        <div class="ai-info">
          <div class="ai-name">Laima AI</div>
          <div class="ai-status">タスクアシスタント</div>
        </div>
      </div>
      <div class="ai-message" id="aiMessage">
        Sveiki! 今日のタスクを整理しましょう。音声または入力でタスクを追加してください。
      </div>
      <div class="ai-actions" id="aiSuggestions">
        <button class="ai-action-btn" onclick="askAI('prioritize')">
          <span>◆</span> 優先度を整理
        </button>
        <button class="ai-action-btn" onclick="askAI('estimate')">
          <span>○</span> 時間見積もり
        </button>
        <button class="ai-action-btn" onclick="askAI('reschedule')">
          <span>↻</span> スケジュール調整
        </button>
      </div>
    </section>

    <!-- Task List -->
    <section class="task-section">
      <div class="section-header">
        <h2 class="section-title">Today's Tasks</h2>
        <span class="task-count" id="taskCount">0</span>
      </div>
      
      <!-- Progress Bar -->
      <div class="progress-section" id="progressSection" style="display: none;">
        <div class="progress-header">
          <span class="progress-label">今日の進捗</span>
          <span class="progress-value" id="progressValue">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="task-list" id="taskList">
        <div class="empty-state">
          <svg viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <p>タスクがまだありません<br>音声または入力で追加してみましょう</p>
        </div>
      </div>
    </section>

    <div class="bottom-spacer"></div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <div class="toast-icon">✦</div>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle"></div>
      <div class="toast-message" id="toastMessage"></div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3>タスクを編集</h3>
      <div class="modal-field">
        <label>タスク名</label>
        <input type="text" id="editTitle">
      </div>
      <div class="modal-field">
        <label>時間</label>
        <input type="time" id="editTime">
      </div>
      <div class="modal-field">
        <label>カテゴリ</label>
        <select id="editCategory">
          <option value="deadline">締め切り</option>
          <option value="research">WEBで調べる</option>
          <option value="create">制作</option>
        </select>
      </div>
      <div class="modal-field">
        <label>所要時間（分）</label>
        <input type="number" id="editDuration" min="5" step="5">
      </div>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closeEditModal()">キャンセル</button>
        <button class="modal-btn primary" onclick="saveEdit()">保存</button>
      </div>
    </div>
  </div>

  <!-- AI Clarification Modal -->
  <div class="modal-overlay" id="clarifyModal">
    <div class="modal">
      <h3>確認</h3>
      <div class="ai-message" id="clarifyMessage"></div>
      <div class="modal-field" style="margin-top: 20px;">
        <input type="text" id="clarifyInput" placeholder="詳細を入力...">
      </div>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closeClarifyModal()">キャンセル</button>
        <button class="modal-btn primary" onclick="submitClarification()">OK</button>
      </div>
    </div>
  </div>

  <!-- Audio for notifications -->
  <audio id="notificationSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp2PfnBocHiMnaCYjH5wZ2x2iJqgnpKEd29xeomaoZ2Rgndudn6NnKKdkIJ4c3R7jJuinJGCeXZ1fIyaoZuQgXl1dXyNm6Gaj4B3c3V9jZyhnY+Bd3R2fI2boJuPgHd1dnyNm6CajoB3dXZ8jZuhmY5/dnV3fY6coZmOf3Z1d32OnKGZjn92dXd9jpyhmY5/dnV3fY6coZmNf3Z2d36OnKCYjX92dnh+jpyfmI1/dnd4fo+dn5iNf3Z3eH6PnZ+YjX91d3h+j52fmI1/dXd4fo+dn5iMf3V4eX+QnZ6Xi391eHl/kJ2elox/dXh5f5CdnpaMf3V4eX+QnZ6WjH91eHl/kJ2dlox/dXl5gJGdnZWLf3V5eoGRnZyVi391eXqBkZ2clYt/dXl6gZGdnJWLfnV6eoGSnZyUin51enqCkp2ck4p+dXp6gpKdnJOKfnV6e4OSnJuTin51e3uDk5ybkol+dnt7g5OcmpKJfnZ7e4OTnJqSiX52e3uDk5yak4l+dnt8hJScmZKJfnZ8fISUnJmSiH52fHyFlZyYkYh9dnx9hZWcmJGIfXZ9fYaVm5eQh312fX2GlpuXkId9d31+hpabl5CHfXd+foaWmpaQhn13fn6HlpqWj4Z9d35/h5ealpCGfXd/f4eXmZWPhn14f3+Il5mVj4V9eH+AiJiZlI+FfXiAgIiYmJSPhX14gICJmJiUjoV9eYCAiZiYlI6FfHmBgYqYl5ONhHx5gYGKmZeTjYR8eYGBipmXk42EfHqBgYuZl5KMg3x6goKLmZaSjIN8eoKCi5mWkoyDfHqCgouZlpKMg3t6goKMmpaRi4N7e4KCjJqVkYuCe3uDg4yalZGLgnt7g4OMmpWQioJ7e4ODjZqVkIqCe3yDg42alJCKgnt8hISOmpSPiYF7fISEjpqUj4mBe3yEhI6ak4+JgXt8hISOmpOPiYF7fYSEj5qTjoiBe32EhY+akI6IgHt9hYWPmo+OiIB7fYWFkJqPjYeAe36FhZCaj42HgHp+hYWQmo6Nh4B6foaGkZqOjIZ/en6GhpGajYyGf3p/hoaRmY2Mhn96f4aGkpmMi4V/en+HhpKZjIuFfnqAh4eTmYyLhX56gIeHk5mLioR+eoCHh5SZi4qEfnqBiIeUmIqKhH16gYiIlJiKiYN9e4GIiJSYiomDfXuBiIiUmImJg316goiIlZiJiIN9eoKJiZWXiIiCfHqCiYmVl4iIgnx6g4mJlpeHh4J8e4OJipWWhoeAfHuDiYqWloaHgHx7g4mKlpaGhoB8e4SJipaVhYaAfHuEioqWlYWFf3t8hIqKl5WFhX97fISKipaUhYR/e3yFioqWlISEf3t9hYuLlpSEhH57fYWLi5aUg4N+e32Fi4uXk4ODfnt+hYuLl5ODg357foaLi5eTgoN+e36Gi4yXkoKCfXt/houMl5KCgn17f4eLjJeRgYF9fH+Hi4yYkYGBfHyAh4uMmJGBgXx8gIiMjJiQgIB8fICIjIyYkICAfHyBiIyNmJCAgHx8gYiMjZiPf398fIGIjI2Yj39/fH2BiY2NmI5/fnx9gomNjpiOf358fYKJjY6Yjn9+fH2CiY2OmI1+fXx9gomOjpiNfn18foKKjo6XjX59fH6Cio6Ol41+fX1+g4qOjpeNfX19foOKjo+XjH19fX6Dio6Pl4x9fX1/g4qPj5eMfX1+f4OLj4+Wi3x9fn+EjI+PlYt8fH5/hIyPj5WLfHx+gISMj5CVinx8f4CEjJCQlYp8fH+AhYyQkJWKe3x/gIWMkJCUiXt7f4GFjZCQlIl7e3+BhY2QkZSJe3uAgYWNkJGUiHt7gIGGjZGRk4h6e4CBho2RkZOIent/gYaNkZGTiHp7gIKGjpGRkod6e4CChY6RkpKHent/goaOkpKSh3l6gIKGjpKSkod5eoGCho6SkpKGeXqBgoePkpKRhnl6gYKHj5KSkYZ5eoGDh4+SkZGFeHqBg4eQkpGRhXh5gYOIkJKRkIV4eYKDiJCSkZCFeHmCg4iQk5GQhHh5goSIkZORkIR4eYKEiJGTkZCEd3mChIiRk5GQg3d5goSJkZORj4N3eYOEiZGTkY+Dd3mDhImSk5GPg3d5g4SJkpORjoJ3eYOFipKTkY6Cd3mDhYqSk5GOgnd4g4WKk5ORjoJ2eIOFipOTkY2Bdnj=" type="audio/wav">
  </audio>

  <script>
    // ========== State Management ==========
    let tasks = [];
    let editingTaskId = null;
    let pendingTaskInput = null;
    let conversationHistory = [];
    let recognition = null;
    let isListening = false;
    let lastVisit = null;

    // ========== Initialize ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadTasks();
      loadLastVisit();
      updateTime();
      setInterval(updateTime, 1000);
      setInterval(checkReminders, 60000);
      initSpeechRecognition();
      showWelcomeBack();
      
      document.getElementById('manualInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') processManualInput();
      });
    });

    // ========== Welcome Back Feature ==========
    function loadLastVisit() {
      try {
        const stored = localStorage.getItem('laima_lastVisit');
        if (stored) {
          lastVisit = new Date(stored);
        }
      } catch (e) {
        console.log('LocalStorage not available');
      }
    }

    function saveLastVisit() {
      try {
        localStorage.setItem('laima_lastVisit', new Date().toISOString());
      } catch (e) {
        console.log('LocalStorage not available');
      }
    }

    function showWelcomeBack() {
      if (tasks.length === 0) {
        document.getElementById('welcomeCard').classList.add('hidden');
        return;
      }

      const completedTasks = tasks.filter(t => t.completed);
      const remainingTasks = tasks.filter(t => !t.completed);
      const totalTasks = tasks.length;
      const progress = totalTasks > 0 ? Math.round((completedTasks.length / totalTasks) * 100) : 0;

      document.getElementById('statRemaining').textContent = remainingTasks.length;
      document.getElementById('statCompleted').textContent = completedTasks.length;
      document.getElementById('statProgress').textContent = progress + '%';

      const hour = new Date().getHours();
      let greeting = 'Sveiki!';
      if (hour < 12) {
        greeting = 'Labas rytas!';
      } else if (hour < 18) {
        greeting = 'Tere päevast!';
      } else {
        greeting = 'Labvakar!';
      }
      document.getElementById('welcomeTitle').textContent = greeting;

      let message = generateWelcomeMessage(remainingTasks, completedTasks, progress);
      document.getElementById('welcomeMessage').textContent = message;

      document.getElementById('welcomeCard').classList.remove('hidden');

      setTimeout(() => {
        setAIMessage(generateAIWelcomeMessage(remainingTasks, completedTasks, progress));
      }, 500);

      saveLastVisit();
    }

    function generateWelcomeMessage(remaining, completed, progress) {
      const now = new Date();
      const currentTime = now.toTimeString().slice(0, 5);

      if (completed.length === 0 && remaining.length > 0) {
        const nextTask = remaining[0];
        return `最初のタスク「${nextTask.title}」（${nextTask.time}）から始めましょう。`;
      }

      if (progress === 100) {
        return 'Puiku! すべてのタスクが完了しています。新しいタスクを追加しますか？';
      }

      if (progress >= 75) {
        return `あと少しです！残り${remaining.length}件のタスクを完了させましょう。`;
      }

      if (progress >= 50) {
        return `順調に進んでいます。次は「${remaining[0]?.title || 'タスク'}」に取り組みましょう。`;
      }

      const overdueTasks = remaining.filter(t => t.time < currentTime);
      if (overdueTasks.length > 0) {
        return `${overdueTasks.length}件のタスクが予定時刻を過ぎています。スケジュールを調整しますか？`;
      }

      const upcomingTasks = remaining.filter(t => t.time >= currentTime);
      if (upcomingTasks.length > 0) {
        const next = upcomingTasks[0];
        return `次のタスク「${next.title}」は${next.time}の予定です。`;
      }

      return `${remaining.length}件のタスクが残っています。頑張りましょう！`;
    }

    function generateAIWelcomeMessage(remaining, completed, progress) {
      if (tasks.length === 0) {
        return 'Sveiki! 今日のタスクを整理しましょう。音声または入力でタスクを追加してください。';
      }

      const now = new Date();
      const currentTime = now.toTimeString().slice(0, 5);
      const overdueTasks = remaining.filter(t => t.time < currentTime);

      if (progress === 100) {
        return 'Apsveicu! すべてのタスクが完了しました。素晴らしい一日ですね。';
      }

      if (overdueTasks.length > 0) {
        return `お帰りなさい。${overdueTasks.length}件のタスクが予定時刻を過ぎています。「スケジュール調整」で時間を見直しましょうか？`;
      }

      if (progress >= 50) {
        return `Labi! ${progress}%完了しています。この調子で残りのタスクも片付けましょう。`;
      }

      const urgentTasks = remaining.filter(t => t.urgent);
      if (urgentTasks.length > 0) {
        return `「${urgentTasks[0].title}」が緊急タスクとして設定されています。優先的に取り組みましょう。`;
      }

      return `${remaining.length}件のタスクが待っています。「${remaining[0]?.title || '最初のタスク'}」から始めましょうか？`;
    }

    // ========== Time & Night Mode ==========
    function updateTime() {
      const now = new Date();
      const options = { 
        hour: '2-digit', 
        minute: '2-digit',
        weekday: 'long',
        month: 'long',
        day: 'numeric'
      };
      document.getElementById('currentTime').textContent = now.toLocaleDateString('ja-JP', options);
      
      const hour = now.getHours();
      const isNightMode = hour >= 21 || hour < 7;
      document.getElementById('nightIndicator').style.display = isNightMode ? 'inline-flex' : 'none';
    }

    function isNightTime() {
      const hour = new Date().getHours();
      return hour >= 21 || hour < 7;
    }

    // ========== Progress Update ==========
    function updateProgress() {
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(t => t.completed).length;
      
      if (totalTasks === 0) {
        document.getElementById('progressSection').style.display = 'none';
        return;
      }

      const progress = Math.round((completedTasks / totalTasks) * 100);
      document.getElementById('progressSection').style.display = 'block';
      document.getElementById('progressValue').textContent = progress + '%';
      document.getElementById('progressFill').style.width = progress + '%';
    }

    // ========== Speech Recognition ==========
    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
          isListening = true;
          document.getElementById('voiceBtn').classList.add('listening');
          document.getElementById('voiceText').textContent = '聞いています...';
        };

        recognition.onresult = (event) => {
          const transcript = Array.from(event.results)
            .map(result => result[0].transcript)
            .join('');
          document.getElementById('voiceText').textContent = transcript;
          
          if (event.results[0].isFinal) {
            processVoiceInput(transcript);
          }
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          document.getElementById('voiceText').textContent = '音声認識エラー。もう一度お試しください。';
          stopListening();
        };

        recognition.onend = () => {
          stopListening();
        };
      } else {
        document.getElementById('voiceBtn').style.display = 'none';
        document.getElementById('voiceText').textContent = 'お使いのブラウザは音声入力に対応していません';
      }
    }

    function toggleVoiceInput() {
      if (isListening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }

    function stopListening() {
      isListening = false;
      document.getElementById('voiceBtn').classList.remove('listening');
    }

    // ========== Task Processing with AI ==========
    async function processVoiceInput(text) {
      document.getElementById('voiceText').textContent = `「${text}」を処理中...`;
      await processTaskInput(text);
    }

    async function processManualInput() {
      const input = document.getElementById('manualInput');
      const text = input.value.trim();
      if (!text) return;
      
      input.value = '';
      await processTaskInput(text);
    }

    async function processTaskInput(text) {
      setAILoading(true);
      
      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [
              ...conversationHistory,
              { 
                role: "user", 
                content: `あなたは「Laima AI」という名前のバルト三国風タスク管理アシスタントです。落ち着いた、温かみのある丁寧な口調で話します。時々バルト三国の言葉（Paldies=ありがとう, Labi=良い, Sveiki=こんにちは など）を混ぜます。

現在時刻: ${new Date().toLocaleString('ja-JP')}
現在のタスク一覧: ${JSON.stringify(tasks.map(t => ({title: t.title, time: t.time, category: t.category, duration: t.duration, completed: t.completed})))}

ユーザーの入力: "${text}"

以下のJSON形式で返答してください。余計な文字は含めないでください：
{
  "action": "add_task" | "clarify" | "chat",
  "task": {
    "title": "タスク名",
    "time": "HH:MM形式の時間（指定がなければ現在時刻から30分後）",
    "category": "deadline" | "research" | "create",
    "duration": 所要時間（分）の数値,
    "urgent": true/false（今日中や急ぎなど緊急性がある場合true）
  },
  "clarifyQuestion": "曖昧な場合の質問",
  "message": "ユーザーへのメッセージ（シンプルに）"
}

カテゴリの判定:
- 「締め切り」「提出」「納品」「入稿」→ deadline
- 「調べる」「検索」「確認」「WEB」→ research  
- 「作る」「制作」「デザイン」「作成」→ create

曖昧な表現（「あの件」「午後」「明日」など）は clarify アクションで確認してください。`
              }
            ]
          })
        });

        const data = await response.json();
        let responseText = data.content[0].text;
        responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
        
        const result = JSON.parse(responseText);
        
        conversationHistory.push({ role: "user", content: text });
        conversationHistory.push({ role: "assistant", content: result.message });
        
        if (conversationHistory.length > 10) {
          conversationHistory = conversationHistory.slice(-10);
        }

        if (result.action === "add_task" && result.task) {
          addTask(result.task);
          setAIMessage(result.message);
        } else if (result.action === "clarify") {
          pendingTaskInput = text;
          showClarifyModal(result.clarifyQuestion);
        } else {
          setAIMessage(result.message);
        }
        
      } catch (error) {
        console.error('AI Error:', error);
        const task = parseBasicTask(text);
        addTask(task);
        setAIMessage('Paldies! タスクを追加しました。');
      }
      
      document.getElementById('voiceText').textContent = 'タップして音声入力';
    }

    function parseBasicTask(text) {
      const timeMatch = text.match(/(\d{1,2})[時:：](\d{2})?/);
      let time = null;
      
      if (timeMatch) {
        const hour = timeMatch[1].padStart(2, '0');
        const minute = timeMatch[2] || '00';
        time = `${hour}:${minute}`;
      } else {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        time = now.toTimeString().slice(0, 5);
      }

      let category = 'create';
      if (text.includes('締切') || text.includes('提出') || text.includes('納品') || text.includes('入稿')) {
        category = 'deadline';
      } else if (text.includes('調べ') || text.includes('検索') || text.includes('WEB') || text.includes('確認')) {
        category = 'research';
      }

      return {
        title: text.replace(/(\d{1,2})[時:：](\d{2})?/g, '').trim(),
        time: time,
        category: category,
        duration: 30,
        urgent: text.includes('急') || text.includes('今日')
      };
    }

    // ========== AI Actions ==========
    async function askAI(action) {
      if (tasks.length === 0) {
        setAIMessage('まずタスクを追加してください。');
        return;
      }

      setAILoading(true);

      const prompts = {
        prioritize: `現在のタスク一覧を確認して、優先度を提案してください。締め切りや緊急度を考慮して。`,
        estimate: `各タスクの所要時間を見積もって、今日のスケジュールが現実的か評価してください。`,
        reschedule: `完了したタスクを考慮して、残りのタスクのスケジュールを調整提案してください。遅れているタスクがあれば指摘してください。`
      };

      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 500,
            messages: [{
              role: "user",
              content: `あなたは「Laima AI」という温かみのあるバルト三国風タスク管理アシスタントです。

現在時刻: ${new Date().toLocaleString('ja-JP')}
タスク一覧: ${JSON.stringify(tasks.map(t => ({
  title: t.title, 
  time: t.time, 
  category: t.category, 
  duration: t.duration + '分', 
  completed: t.completed,
  urgent: t.urgent
})), null, 2)}

${prompts[action]}

簡潔に返答してください（100文字以内）。時々バルト語を混ぜてください。`
            }]
          })
        });

        const data = await response.json();
        setAIMessage(data.content[0].text);
      } catch (error) {
        setAIMessage('申し訳ありません、エラーが発生しました。');
      }
    }

    // ========== Task Management ==========
    function addTask(taskData) {
      const task = {
        id: Date.now(),
        title: taskData.title,
        time: taskData.time,
        category: taskData.category || 'create',
        duration: taskData.duration || 30,
        urgent: taskData.urgent || false,
        completed: false,
        createdAt: new Date().toISOString()
      };
      
      tasks.push(task);
      tasks.sort((a, b) => a.time.localeCompare(b.time));
      saveTasks();
      renderTasks();
      updateProgress();
      
      if (tasks.length === 1) {
        document.getElementById('welcomeCard').classList.add('hidden');
      }
    }

    function toggleTask(id) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        task.completed = !task.completed;
        
        if (task.completed) {
          const now = new Date();
          const [hours, minutes] = task.time.split(':').map(Number);
          const taskTime = new Date();
          taskTime.setHours(hours, minutes, 0);
          
          if (now < taskTime) {
            setAIMessage(`Lieliski! 「${task.title}」を予定より早く完了しました。次のタスクに余裕ができましたね。`);
          } else {
            setAIMessage(`Labi! 「${task.title}」が完了しました。`);
          }

          const completedCount = tasks.filter(t => t.completed).length;
          const totalCount = tasks.length;
          if (completedCount === totalCount) {
            setTimeout(() => {
              setAIMessage('Apsveicu! すべてのタスクが完了しました。素晴らしい一日でしたね！');
            }, 1500);
          }
        }
        
        saveTasks();
        renderTasks();
        updateProgress();
      }
    }

    function deleteTask(id) {
      tasks = tasks.filter(t => t.id !== id);
      saveTasks();
      renderTasks();
      updateProgress();
    }

    function editTask(id) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        editingTaskId = id;
        document.getElementById('editTitle').value = task.title;
        document.getElementById('editTime').value = task.time;
        document.getElementById('editCategory').value = task.category;
        document.getElementById('editDuration').value = task.duration;
        document.getElementById('editModal').classList.add('show');
      }
    }

    function saveEdit() {
      const task = tasks.find(t => t.id === editingTaskId);
      if (task) {
        task.title = document.getElementById('editTitle').value;
        task.time = document.getElementById('editTime').value;
        task.category = document.getElementById('editCategory').value;
        task.duration = parseInt(document.getElementById('editDuration').value) || 30;
        
        tasks.sort((a, b) => a.time.localeCompare(b.time));
        saveTasks();
        renderTasks();
      }
      closeEditModal();
    }

    function closeEditModal() {
      editingTaskId = null;
      document.getElementById('editModal').classList.remove('show');
    }

    // ========== Clarification Modal ==========
    function showClarifyModal(question) {
      document.getElementById('clarifyMessage').textContent = question;
      document.getElementById('clarifyInput').value = '';
      document.getElementById('clarifyModal').classList.add('show');
    }

    function closeClarifyModal() {
      pendingTaskInput = null;
      document.getElementById('clarifyModal').classList.remove('show');
      setAIMessage('Labi, また何かあればお知らせください。');
    }

    async function submitClarification() {
      const clarification = document.getElementById('clarifyInput').value;
      document.getElementById('clarifyModal').classList.remove('show');
      
      if (clarification && pendingTaskInput) {
        await processTaskInput(`${pendingTaskInput}（補足: ${clarification}）`);
      }
      pendingTaskInput = null;
    }

    // ========== Rendering ==========
    function renderTasks() {
      const container = document.getElementById('taskList');
      const incompleteTasks = tasks.filter(t => !t.completed);
      const completedTasks = tasks.filter(t => t.completed);
      
      document.getElementById('taskCount').textContent = incompleteTasks.length;

      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <p>タスクがまだありません<br>音声または入力で追加してみましょう</p>
          </div>
        `;
        return;
      }

      const categoryLabels = {
        deadline: '締め切り',
        research: 'WEBで調べる',
        create: '制作'
      };

      const now = new Date();
      const currentTime = now.toTimeString().slice(0, 5);

      const renderTask = (task) => {
        const isOverdue = !task.completed && task.time < currentTime;
        const isInProgress = !task.completed && !isOverdue && 
          incompleteTasks.indexOf(task) === 0;

        return `
          <div class="task-item ${task.completed ? 'completed' : ''} ${task.urgent && !task.completed ? 'urgent' : ''} ${isInProgress ? 'in-progress' : ''}">
            <div class="task-header">
              <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                ${task.completed ? '✓' : ''}
              </div>
              <div class="task-content">
                <div class="task-title">${task.title}</div>
                <div class="task-meta">
                  <span class="task-tag task-time">${task.time}${isOverdue ? ' (遅延)' : ''}</span>
                  <span class="task-tag task-category ${task.category}">${categoryLabels[task.category]}</span>
                  <span class="task-tag task-duration">${task.duration}分</span>
                </div>
              </div>
            </div>
            <div class="task-actions">
              <button class="task-action-btn" onclick="editTask(${task.id})">編集</button>
              <button class="task-action-btn delete" onclick="deleteTask(${task.id})">削除</button>
            </div>
          </div>
        `;
      };

      container.innerHTML = [
        ...incompleteTasks.map(renderTask),
        ...completedTasks.map(renderTask)
      ].join('');
    }

    // ========== Notifications ==========
    function checkReminders() {
      const now = new Date();
      const currentTime = now.toTimeString().slice(0, 5);
      
      tasks.forEach(task => {
        if (!task.completed && task.time === currentTime && !task.notified) {
          showNotification(task);
          task.notified = true;
          saveTasks();
        }
      });
    }

    function showNotification(task) {
      const toast = document.getElementById('toast');
      document.getElementById('toastTitle').textContent = task.title;
      document.getElementById('toastMessage').textContent = `${task.time} — 予定の時間です`;
      
      toast.classList.add('show');
      
      if (!isNightTime()) {
        const audio = document.getElementById('notificationSound');
        audio.volume = 0.25;
        audio.play().catch(() => {});
      }
      
      if (Notification.permission === 'granted') {
        new Notification('Laima', {
          body: `${task.title}\n${task.time} — 予定の時間です`,
          silent: isNightTime()
        });
      }
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 5000);
    }

    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // ========== UI Helpers ==========
    function setAIMessage(message) {
      const el = document.getElementById('aiMessage');
      el.classList.remove('loading');
      el.innerHTML = message;
    }

    function setAILoading(loading) {
      const el = document.getElementById('aiMessage');
      if (loading) {
        el.classList.add('loading');
        el.innerHTML = '考え中';
      }
    }

    // ========== Storage ==========
    function saveTasks() {
      try {
        localStorage.setItem('laima_tasks', JSON.stringify(tasks));
        window._taskData = tasks;
      } catch (e) {
        window._taskData = tasks;
      }
    }

    function loadTasks() {
      try {
        const stored = localStorage.getItem('laima_tasks');
        if (stored) {
          tasks = JSON.parse(stored);
          const today = new Date().toDateString();
          tasks.forEach(t => {
            const taskDate = new Date(t.createdAt).toDateString();
            if (taskDate !== today) {
              t.notified = false;
            }
          });
          renderTasks();
          updateProgress();
        } else if (window._taskData) {
          tasks = window._taskData;
          renderTasks();
          updateProgress();
        }
      } catch (e) {
        if (window._taskData) {
          tasks = window._taskData;
          renderTasks();
          updateProgress();
        }
      }
    }
  </script>
</body>
</html>
